
<div class="container-fluid" ng-controller="SendMessageReportCtrl as sendMessageReportCtrl">
    <div class="page-header d-print-none">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="page-title">
                    {{'REPORT.SEND_MESSAGE_LIST' | translate}}
                </h2>
            </div>
        </div>
    </div>
    <div class="row align-content-center d-print-none">
        <div class="col-md-12">
            <form ng-submit="onSearchDocumentGroupChange()">
                <input type="submit" hidden>
                <div class="row g-2 mb-3">
                    <div class="col-lg-auto col-md-2">
                        <select class="form-select" ng-change="onSearchDocumentGroupChange()" ng-model="sendMessageReportCtrl.searchSendMessage.document_group_id">
                            <option ng-repeat="group in sendMessageReportCtrl.lstDocumentGroup" value="{{group.id}}">{{group.name}}</option>
                        </select>
                    </div>
                    <div class="col-lg-auto col-md-2">
                        <select class="form-select" ng-change="onSearchSendMessage()" ng-model="sendMessageReportCtrl.searchSendMessage.document_type_id">
                            <option value="-1">{{'REPORT.DOCUMENT_TYPE' | translate}}</option>
                            <option ng-repeat="document_type in sendMessageReportCtrl.lstDocumentTypeSearch" value="{{document_type.id}}">{{document_type.dc_type_name}}</option>
                        </select>
                    </div>
                    <div class="col-lg-auto col-md-2">
                        <select class="form-select" ng-change="onSearchSendMessage()"
                        ng-model="sendMessageReportCtrl.searchSendMessage.dc_style">
                        <option value="-1">{{'REPORT.DOCUMENT_STYLE.DEFAULT' | translate}}</option>
                        <option
                            ng-repeat="style in lstDocumentStyle"
                            value="{{style.id}}">{{style.description | translate}}</option>
                    </select>
                    </div>
                    <div class="col-lg-auto">
                        <div class="input-icon">
                            <input class="form-control" ng-flatpickr fp-opts="dateOpts" fp-on-setup="datePostSetup(fpItem)" placeholder="{{'COMMON.PH_DATEPICKER' | translate}}" ng-model="sendMessageReportCtrl.searchSendMessage.start_date" data-enabletime="false">
                            <span class="input-icon-addon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <rect x="4" y="5" width="16" height="16" rx="2"></rect>
                                    <line x1="16" y1="3" x2="16" y2="7"></line>
                                    <line x1="8" y1="3" x2="8" y2="7"></line>
                                    <line x1="4" y1="11" x2="20" y2="11"></line>
                                    <line x1="11" y1="15" x2="12" y2="15"></line>
                                    <line x1="12" y1="15" x2="12" y2="18"></line>
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div class="col-lg-auto">
                        <div class="input-icon">
                            <input class="form-control" ng-flatpickr fp-opts="dateOpts" fp-on-setup="datePostSetup(fpItem)" placeholder="{{'COMMON.PH_DATEPICKER' | translate}}" ng-model="sendMessageReportCtrl.searchSendMessage.end_date" data-enabletime="false">
                            <span class="input-icon-addon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <rect x="4" y="5" width="16" height="16" rx="2"></rect>
                                    <line x1="16" y1="3" x2="16" y2="7"></line>
                                    <line x1="8" y1="3" x2="8" y2="7"></line>
                                    <line x1="4" y1="11" x2="20" y2="11"></line>
                                    <line x1="11" y1="15" x2="12" y2="15"></line>
                                    <line x1="12" y1="15" x2="12" y2="18"></line>
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <a ng-click="onSearchSendMessage()" class="btn btn-primary btn-icon"
                            aria-label="Button">
                            {{'COMMON.SEARCH' | translate}}
                        </a>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-small btn-primary"
                        ng-click="onViewReportDetail()" ng-if="sendMessageReportCtrl.lstSendMessage.length > 0">{{'REPORT.VIEW_REPORT' | translate}}</button>
                    </div>
                </div>
            </form>

        </div>
        <div class="col-12">
            <style>
                li {
                    list-style-type: none;
                }
                .label {
                    margin-left: 15px;
                    font-family: 'Source Sans Pro', sans-serif;
                    color: #666666;
                    font-size: 14px;
                }

                .legendValue {
                    float: left;
                }

                .clear {
                    clear: both
                }
            </style>
            <div class="row">
                <div class="col-md-6 col-xl-6">
                    <div class="row">
                        <div class="card shadow-none" style="border-radius: 0px;">
                            <div class="card-body" style="position: relative;">
                                <div class="row">
                                    <div class="d-flex d-print-none">
                                        <h3 class="card-title">{{'REPORT.SEND_SMS_REPORT' | translate}}</h3>
                                        <!-- <a class="text-right" title="Tải về máy"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="12" y1="11" x2="12" y2="17" /><polyline points="9 14 12 17 15 14" /></svg></a> -->
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <canvas id="pieChart_message_report_sms" style="width: 100%;height: 360px;"></canvas>
                                    <div id="pieChart_message_report_sms_legend"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-6">
                    <div class="row">
                        <div class="card shadow-none" style="border-radius: 0px;">
                            <div class="card-body" style="position: relative;">
                                <div class="row">
                                    <div class="d-flex d-print-none">
                                        <h3 class="card-title">{{'REPORT.SEND_EMAIL_REPORT' | translate}}</h3>
                                        <!-- <a class="text-right" title="Tải về máy"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="12" y1="11" x2="12" y2="17" /><polyline points="9 14 12 17 15 14" /></svg></a> -->
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <canvas id="pieChart_message_report_email" style="width: 100%;height: 360px;"></canvas>
                                    <div id="pieChart_message_report_email_legend"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button id="renderMessageChart" onclick="render_chart_message()" hidden></button>
    <div class="modal fade" id="reportMessageDetail" tabindex="-1" role="dialog"
        aria-hidden="true">
        <div class="modal-dialog modal-xl" style="pointer-events:inherit;">
            <div class="modal-header" style="border-bottom: none;">
                <h5 class="modal-title">{{'REPORT.REPORT_DETAIL' | translate}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-content table-responsive" style="border-radius: 0px; border-top: 1px solid; border-bottom: 1px solid">
                <table
                    class="table card-table table-vcenter table-striped text-nowrap datatable table-hover dataTable no-footer"
                    datatable="" dt-instance="sendMessageReportCtrl.dtInstance"
                    dt-options="sendMessageReportCtrl.dtOptions" style="width:100%;" dt-columns="sendMessageReportCtrl.dtColumns">
                </table>
            </div>
            <div class="modal-footer">
                <div class="btn-list ms-auto">
                    <a class="btn btn-secondary" data-bs-dismiss="modal" >{{"COMMON.CLOSE" |
                        translate}}</a>
                    <button type="button" class="btn btn-primary ms-auto" ng-click="export()">{{'REPORT.EXPORT' |
                        translate}}</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        var getSuitableYSendMessage = (y, yArray = [], direction) => {
            let result = y;
            yArray.forEach((existedY) => {
                if (existedY - 16 < result && existedY + 16 > result) {
                if (direction === "right") {
                    result = existedY + 16;
                } else {
                    result = existedY - 16;
                }
            }
            });

            return result;
        };
        var pieLabelsLineSendMessage = {
            id: "pieLabelsLineSendMessage",
            afterDraw: function(chart){
                const ctx = chart.chart.ctx;
                ctx.save();
                ctx.font = "12px 'Averta Std CY'";
                const leftLabelCoordinates = [];
                const rightLabelCoordinates = [];
                const chartCenterPoint = {
                x: (chart.chartArea.right - chart.chartArea.left) / 2 + chart.chartArea.left,
                y: (chart.chartArea.bottom - chart.chartArea.top) / 2 + chart.chartArea.top
                };

                chart.config.data.labels.forEach((label, i) => {
                    const meta = chart.getDatasetMeta(0);
                    const arc = meta.data[i];
                    const dataset = chart.config.data.datasets[0];
                    const sum = dataset.data.reduce((a, b) => a + b, 0);
                    // Prepare data to draw
                    // important point 1
                    const centerPoint = arc.getCenterPoint();
                    const model = arc._model;
                    let color = model.backgroundColor;
                    let labelColor = model.backgroundColor;

                    const angle = Math.atan2(
                        centerPoint.y - chartCenterPoint.y,
                        centerPoint.x - chartCenterPoint.x
                    );
                    // important point 2, this point overlapsed with existed points
                    // so we will reduce y by 14 if it's on the right
                    // or add by 14 if it's on the left
                    const point2X = chartCenterPoint.x + Math.cos(angle) * (model.outerRadius + 10);
                    let point2Y = chartCenterPoint.y + Math.sin(angle) * (model.outerRadius + 10);

                    let suitableY;
                    if (point2X < chartCenterPoint.x) {
                    // on the left
                        suitableY = getSuitableYSendMessage(point2Y, leftLabelCoordinates, "left");
                    } else {
                    // on the right

                    suitableY = getSuitableYSendMessage(point2Y, rightLabelCoordinates, "right");
                    }

                    point2Y = suitableY;

                    let value = ((dataset.data[i] * 100) / sum).toFixed(2) + '%';
                    if (dataset.polyline && dataset.polyline.formatter) {
                        value = dataset.polyline.formatter(value);
                    }
                    let edgePointX = point2X < chartCenterPoint.x ? chart.width/5.5 : chart.width - (chart.width/5.5);

                    if (point2X < chartCenterPoint.x) {
                        leftLabelCoordinates.push(point2Y);
                    } else {
                        rightLabelCoordinates.push(point2Y);
                    }
                    //DRAW CODE
                    // first line: connect between arc's center point and outside point
                    if(dataset.data[i] > 0){
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        ctx.moveTo(centerPoint.x, centerPoint.y);
                        ctx.lineTo(point2X, point2Y);
                        ctx.stroke();
                        // second line: connect between outside point and chart's edge
                        ctx.beginPath();
                        ctx.moveTo(point2X, point2Y);
                        ctx.lineTo(edgePointX, point2Y);
                        ctx.stroke();
                        //fill custom label
                        const labelAlignStyle =
                        edgePointX < chartCenterPoint.x ? "left" : "right";
                        const labelX = edgePointX;
                        const labelY = point2Y;
                        ctx.textAlign = labelAlignStyle;
                        ctx.textBaseline = "bottom";

                        ctx.fillStyle = labelColor;
                        ctx.fillText(value, labelX, labelY);
                    }
                });
                ctx.restore();
            }
        }
        var noDataLabelsSendMessage = {
            id: "noDataLabelsSendMessage",
            afterDraw: function (chart) {
                if (chart.data.datasets[0].data.every(item => item === 0)) {
                    let ctx = chart.chart.ctx;
                    let width = chart.chart.width;
                    let height = chart.chart.height;

                    chart.clear();
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = "20px Arial";
                    ctx.fillText('Không có dữ liệu để hiển thị', width / 2, height / 2);
                    ctx.restore();
                }
            }
        }
        var pieChart_message_report_sms;
        var pieChart_message_report_email;
        function render_chart_message() {
            if(pieChart_message_report_sms){
                pieChart_message_report_sms.destroy();
            }
            if(pieChart_message_report_email){
                pieChart_message_report_email.destroy();
            }
            var pieCtx_message_report_sms = document.getElementById('pieChart_message_report_sms').getContext('2d');
            var pieCtx_message_report_email = document.getElementById('pieChart_message_report_email').getContext('2d');
            var sms_status_label = angular.element(document.querySelector('[ng-controller="SendMessageReportCtrl as sendMessageReportCtrl"]')).scope().sms_status_label;
            var email_status_label = angular.element(document.querySelector('[ng-controller="SendMessageReportCtrl as sendMessageReportCtrl"]')).scope().email_status_label;
            var pieData_message_report_sms = angular.element(document.querySelector('[ng-controller="SendMessageReportCtrl as sendMessageReportCtrl"]')).scope().pieData_sms;
            var pieData_message_report_email = angular.element(document.querySelector('[ng-controller="SendMessageReportCtrl as sendMessageReportCtrl"]')).scope().pieData_email;
            pieChart_message_report_sms = new Chart(pieCtx_message_report_sms, {
                type: 'pie',
                plugins: [pieLabelsLineSendMessage, noDataLabelsSendMessage],
                data: {
                    labels: sms_status_label,
                    datasets: [
                        {
                            backgroundColor: [
                                "rgba(116, 184, 22, 1)",
                                "rgba(241, 242, 62, 1)",
                                "rgba(224, 56, 16, 1)",
                            ],
                            hoverBackgroundColor: ["rgba(116, 184, 22, 0.6)", "rgba(241, 242, 62, 0.6)", "rgba(224, 56, 16, 0.6)"],
                            borderColor: "#fff",
                            borderCapStyle: 'butt',
                            borderDashOffset: 0.0,
                            borderJoinStyle: 'miter',
                            data: pieData_message_report_sms,
                            polyline: {
                                formatter: (value) => `${value}`
                            }
                        },
                    ],
                },
                options: {
                    cutoutPercentage: 60,
                    legend: false,
                    legendCallback: function (chart) {
                        var text = [];
                        text.push('<ul class="' + chart.id + '-legend_url">');
                        for (var i = 0; i < chart.data.labels.length; i++) {
                            if (chart.data.labels[i] && chart.data.datasets[0].data[i] > 0) {
                                var bgColor = chart.data.datasets[0].backgroundColor[i] ? chart.data.datasets[0].backgroundColor[i] : '#6c757d';
                                text.push('<li><div class="legendValue"><span style="background-color:' + bgColor + '">&nbsp;&nbsp;&nbsp;</span>');
                                text.push('<span class="label">' + chart.data.labels[i] + '</span>');
                                text.push('</div></li><div class="clear"></div>');
                            }
                        }

                        text.push('</ul>');
                        return text.join('');
                    },
                    layout: {
                        padding: 50
                    },
                    plugins: {
                        datalabels: {
                            display: false
                            // labels: {
                            //     title: {
                            //         font: {
                            //             weight: 'bold',
                            //             size: '18'
                            //         }
                            //     }
                            // },
                            // formatter: (value, ctx) => {

                            //     let datasets = ctx.chart.data.datasets;

                            //     if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            //         let sum = datasets[0].data.reduce((a, b) => a + b, 0);
                            //         let percentage = Math.round((value / sum) * 100) + '%';
                            //         return percentage;
                            //     } else {
                            //         return percentage;
                            //     }
                            // },
                            // color: '#fff',
                        }
                    }
                }
            })
            pieChart_message_report_email = new Chart(pieCtx_message_report_email, {
                type: 'pie',
                plugins: [pieLabelsLineSendMessage, noDataLabelsSendMessage],
                data: {
                    labels: email_status_label,
                    datasets: [
                        {
                            backgroundColor: [
                                "rgba(116, 184, 22, 1)",
                                "rgba(241, 242, 62, 1)",
                                "rgba(224, 56, 16, 1)",
                            ],
                            hoverBackgroundColor: ["rgba(116, 184, 22, 0.6)", "rgba(241, 242, 62, 0.6)", "rgba(224, 56, 16, 0.6)"],
                            borderColor: "#fff",
                            borderCapStyle: 'butt',
                            borderDashOffset: 0.0,
                            borderJoinStyle: 'miter',
                            data: pieData_message_report_email,
                            polyline: {
                                formatter: (value) => `${value}`
                            }
                        },
                    ],
                },
                options: {
                    cutoutPercentage: 60,
                    legend: false,
                    legendCallback: function (chart) {
                        var text = [];
                        text.push('<ul class="' + chart.id + '-legend_url">');
                        for (var i = 0; i < chart.data.labels.length; i++) {
                            if (chart.data.labels[i] && chart.data.datasets[0].data[i] > 0) {
                                var bgColor = chart.data.datasets[0].backgroundColor[i] ? chart.data.datasets[0].backgroundColor[i] : '#6c757d';
                                text.push('<li><div class="legendValue"><span style="background-color:' + bgColor + '">&nbsp;&nbsp;&nbsp;</span>');
                                text.push('<span class="label">' + chart.data.labels[i] + '</span>');
                                text.push('</div></li><div class="clear"></div>');
                            }
                        }

                        text.push('</ul>');
                        return text.join('');
                    },
                    layout: {
                        padding: 20
                    },
                    plugins: {
                        datalabels: {
                            display: false,
                            // labels: {
                            //     title: {
                            //         font: {
                            //             weight: 'bold',
                            //             size: '18'
                            //         }
                            //     }
                            // },
                            // formatter: (value, ctx) => {

                            //     let datasets = ctx.chart.data.datasets;

                            //     if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                            //         let sum = datasets[0].data.reduce((a, b) => a + b, 0);
                            //         let percentage = Math.round((value / sum) * 100) + '%';
                            //         return percentage;
                            //     } else {
                            //         return percentage;
                            //     }
                            // },
                            // color: '#fff',
                        }
                    }
                }
            })
            $('#pieChart_message_report_sms_legend').html(pieChart_message_report_sms.generateLegend());
            $('#pieChart_message_report_email_legend').html(pieChart_message_report_email.generateLegend());
            }
    </script>
</div>
